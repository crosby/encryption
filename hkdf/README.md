# HMAC-based Key Derivation Functions

## Introduction

HKDFs are a bit like pseudorandom number generators (PRNGs) in that they generate usefully random data for use in cryptography.

However KDFs differ a little:

1. They don't expect a uniformly random secret like PRNGs do
1. KDFs are expected to be deterministic
1. Useful for producing a _few_ random numbers and not a lot like a PRNG is useful for

## Purpose

HKDF is used to deterministically generate random numbers as part of cryptography.

It's often used in the following (pre-quantum) flow:

1. Alice and bob both generate X25519 keys
2. Alice computes a shared secret using ECDH using:
    1. Her private key
    2. Bob's public key
3. Alice uses HKDF to deterministically generate key material using:
    1. The shared secret as input keying material
    2. A randomly generated salt
    3. A label that specifies the purpose/version
4. Alice then uses AES-GCM to encrypt something using:
    1. A key generated by HKDF
    2. A randomly generated IV
    3. The plaintext
5. Alice sends:
    1. Her public key
    2. The salt used by HKDF to generate the key material
    3. The IV used in AES-GCM to encrypt
    4. The ciphertext and authentication tag
6. Bob receives and then first calculates the same ECDH shared secret using:
    1. His private key
    2. Alice's public key
7. Bob then uses HKDF to deterministically generate the same key material using:
    1. The ECDH shared secret he generated
    2. The salt from the message
    3. The same label
8. Bob then uses AES-GCM to decrypt the ciphertext using:
    1. The key generated by HKDF
    2. The IV from the message
    3. The ciphertext

## Best Practices

HKDF specifies three input parameters; Input Keying Material (IKM), Salt and Info.

* IKM
  * Often an ECDH/ML-KEM shared secret or hardware seed
  * 128-bit entropy or more
  * Don't reuse across unrelated sessions without changing salt/info
  * Generate randomly
* Salt
  * Should be generated fresh per session
  * Doesn't need to be secret
  * Transmit with ciphertext
* Info
  * Short structured label that fixes version and purpose
  * Don't reuse labels for different purposes
  * Is defined by the "protocol" that is being developed
